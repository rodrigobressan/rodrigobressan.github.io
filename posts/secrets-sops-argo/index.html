<!doctype html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Managing K8S secrets with ArgoCD and SOPS" /><meta property="og:locale" content="en" /><meta name="description" content="ArgoCD is a popular tool for managing Kubernetes resources, providing a declarative way to define and maintain the desired state of your applications running in a Kubernetes cluster. One essential aspect of deploying applications securely is managing secrets. Kubernetes provides the concept of secrets, but handling them effectively within ArgoCD can be a challenge. This is where Ksops comes to the rescue. In this blog post, we will explore how to use Ksops to manage secrets in ArgoCD, ensuring a more secure and efficient deployment process. Understanding ArgoCD Secrets Before diving into the details of Ksops, let’s briefly understand how ArgoCD manages secrets. ArgoCD uses a GitOps approach, storing application configurations in a Git repository. While application manifests can be version-controlled and audited, secrets require extra care due to their sensitive nature. ArgoCD offers several options for managing secrets: Git-Secrets: Secrets can be stored in a Git repository, encrypted using sops or a similar tool. However, this may not be the most secure option, as it still exposes secrets to anyone with access to the repository. External Secret Management: You can use an external secret management tool such as HashiCorp Vault, Kubernetes secrets, or a cloud provider’s secret manager. While this approach provides better security, it can be more complex to set up and manage. Enter Ksops Ksops (Kustomize-SOPS) is a powerful tool designed to simplify and secure the management of secrets in Kubernetes, especially in GitOps workflows like ArgoCD. Ksops takes a declarative approach to secret management, allowing you to store encrypted secrets alongside your application manifests in the same Git repository. It offers the following benefits: Zero Trust Secrets: With Ksops, secrets are stored in the same Git repository as your application manifests, but they are securely encrypted. This means you don’t have to rely on the secrecy of your Git repository, following the “Zero Trust” principle. Ease of Use: Ksops integrates seamlessly with ArgoCD and other GitOps tools, making it easy to incorporate into your existing workflow. Strong Encryption: Ksops uses strong encryption algorithms to protect your secrets, ensuring they remain confidential. Audit Trail: Since secrets are version-controlled in the Git repository, you can maintain a clear audit trail of who made changes to the secrets. Installing SOPS In order to install SOPS, make sure you have pip installed on your environment, and then download the SOPS package with: 1 $ pip install sops Configuring SOPS (Secrets Manager) Now that we have SOPS installed on our machine, let’s look on how to configure it to use our personal GPG keys Generate GPG Keys 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ export GPG_NAME=&quot;k3s.argotest.cluster&quot; $ export GPG_COMMENT=&quot;argocd secrets&quot; $ gpg --batch --full-generate-key &lt;&lt;EOF %no-protection Key-Type: 1 Key-Length: 4096 Subkey-Type: 1 Subkey-Length: 4096 Expire-Date: 0 Name-Comment: ${GPG_COMMENT} Name-Real: ${GPG_NAME} EOF With the following command, we create a new GPG key of 4096 bytes, and add a comment and name to it (in order to be able to distinguish it easily from others) Retrieve key name 1 $ gpg --list-secret-keys &quot;${GPG_NAME}&quot; This command will output you the ID of your GPG key, which will be used from now on to identiy your GPG key. Store the GPG key fingerprint as an environment variable 1 $ export GPG_ID=&lt;OUTPUT_FROM_PREVIOUS_COMMAND&gt; Export the public and private key pair from the GPG key and create a kubernetes secret for ArgoCD to read them 1 2 3 4 5 $ gpg --export-secret-keys --armor &quot;${GPG_ID}&quot; | kubectl create secret generic sops-gpg \ --namespace=argocd \ --from-file=sops.asc=/dev/stdin Make sure to replace argocd for the namespace in which argo is being deployed Store the public key (so other people can encrypt secrets) 1 gpg --export --armor &quot;${GPG_ID}&quot; &gt; .sops.pub.asc And the key can be imported by other people with: 1 &gt; gpg --import .sops.pub.asc ` Configure ArgoCD with KSOPS On ArgoCD configmap (argocd-cm), add the following key and value: kustomize.buildOptions: –enable-alpha-plugins Patching ArgoCD Repo server Patch the Argo CD repo server deployment with the following contents: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 apiVersion: apps/v1 kind: Deployment metadata: name: argocd-repo-server namespace: argocd spec: template: spec: initContainers: - name: install-ksops image: viaductoss/ksops:v4.2.5 command: - /bin/sh - &#39;-c&#39; args: - &gt;- echo &quot;Installing KSOPS...&quot;; mv ksops /custom-tools/; mv kustomize/custom-tools/; echo &quot;Done.&quot;; volumeMounts: - mountPath: /custom-tools name: custom-tools - name: import-gpg-key image: argoproj/argocd:v2.1.7 command: [&quot;gpg&quot;, &quot;--import&quot;,&quot;/sops-gpg/sops.asc&quot;] env: - name: GNUPGHOME value: /gnupg-home/.gnupg volumeMounts: - mountPath: /sops-gpg name: sops-gpg - mountPath: /gnupg-home name: gnupg-home containers: - name: argocd-repo-server env: - name: XDG_CONFIG_HOME value: /.config - name: GNUPGHOME value: /home/argocd/.gnupg volumeMounts: - mountPath: /home/argocd/.gnupg name: gnupg-home subPath: .gnupg - mountPath: /usr/local/bin/kustomize name: custom-tools subPath: kustomize - mountPath: /.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops name: custom-tools subPath: ksops volumes: - name: custom-tools emptyDir: {} - name: gnupg-home emptyDir: {} - name: sops-gpg secret: secretName: sops-gpg What are we doing here? We are settign up an initContainer for our ArgoCD deployment, which contains: The KSOPS installer The GPG Key importer Patch it with: 1 $ kubectl patch deployment -n argocd argocd-repo-server --patch &quot;$(cat repo-deploy-patch.yaml) Creating a KSOPS secrets generator Inside the Kustmize overlay (info here), create a secret generator object: 1 2 3 4 5 6 7 apiVersion: viaduct.ai/v1 kind: ksops metadata: # Specify a name name: example-secret-generator files: - ./argo-secret.yaml Where argo-secret refers to the secret to be decrypted by ksops. With this done, reference the generator inside the kustomization.yaml file: 1 2 generators: - ./secrets-generator.yaml Conclusion And voilà! With this setup, everytime you need to encrypt a secret, you just need to: Encrypt the file with sops --encrypt &lt;filename&gt; (for example, a secrets.yaml file) Add the file reference to the secrets-generator.yaml file Commit the encrypted file to your Git Repo ArgoCD will take care of leveraging KSOPS for decrypting the secrets content" /><meta property="og:description" content="ArgoCD is a popular tool for managing Kubernetes resources, providing a declarative way to define and maintain the desired state of your applications running in a Kubernetes cluster. One essential aspect of deploying applications securely is managing secrets. Kubernetes provides the concept of secrets, but handling them effectively within ArgoCD can be a challenge. This is where Ksops comes to the rescue. In this blog post, we will explore how to use Ksops to manage secrets in ArgoCD, ensuring a more secure and efficient deployment process. Understanding ArgoCD Secrets Before diving into the details of Ksops, let’s briefly understand how ArgoCD manages secrets. ArgoCD uses a GitOps approach, storing application configurations in a Git repository. While application manifests can be version-controlled and audited, secrets require extra care due to their sensitive nature. ArgoCD offers several options for managing secrets: Git-Secrets: Secrets can be stored in a Git repository, encrypted using sops or a similar tool. However, this may not be the most secure option, as it still exposes secrets to anyone with access to the repository. External Secret Management: You can use an external secret management tool such as HashiCorp Vault, Kubernetes secrets, or a cloud provider’s secret manager. While this approach provides better security, it can be more complex to set up and manage. Enter Ksops Ksops (Kustomize-SOPS) is a powerful tool designed to simplify and secure the management of secrets in Kubernetes, especially in GitOps workflows like ArgoCD. Ksops takes a declarative approach to secret management, allowing you to store encrypted secrets alongside your application manifests in the same Git repository. It offers the following benefits: Zero Trust Secrets: With Ksops, secrets are stored in the same Git repository as your application manifests, but they are securely encrypted. This means you don’t have to rely on the secrecy of your Git repository, following the “Zero Trust” principle. Ease of Use: Ksops integrates seamlessly with ArgoCD and other GitOps tools, making it easy to incorporate into your existing workflow. Strong Encryption: Ksops uses strong encryption algorithms to protect your secrets, ensuring they remain confidential. Audit Trail: Since secrets are version-controlled in the Git repository, you can maintain a clear audit trail of who made changes to the secrets. Installing SOPS In order to install SOPS, make sure you have pip installed on your environment, and then download the SOPS package with: 1 $ pip install sops Configuring SOPS (Secrets Manager) Now that we have SOPS installed on our machine, let’s look on how to configure it to use our personal GPG keys Generate GPG Keys 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ export GPG_NAME=&quot;k3s.argotest.cluster&quot; $ export GPG_COMMENT=&quot;argocd secrets&quot; $ gpg --batch --full-generate-key &lt;&lt;EOF %no-protection Key-Type: 1 Key-Length: 4096 Subkey-Type: 1 Subkey-Length: 4096 Expire-Date: 0 Name-Comment: ${GPG_COMMENT} Name-Real: ${GPG_NAME} EOF With the following command, we create a new GPG key of 4096 bytes, and add a comment and name to it (in order to be able to distinguish it easily from others) Retrieve key name 1 $ gpg --list-secret-keys &quot;${GPG_NAME}&quot; This command will output you the ID of your GPG key, which will be used from now on to identiy your GPG key. Store the GPG key fingerprint as an environment variable 1 $ export GPG_ID=&lt;OUTPUT_FROM_PREVIOUS_COMMAND&gt; Export the public and private key pair from the GPG key and create a kubernetes secret for ArgoCD to read them 1 2 3 4 5 $ gpg --export-secret-keys --armor &quot;${GPG_ID}&quot; | kubectl create secret generic sops-gpg \ --namespace=argocd \ --from-file=sops.asc=/dev/stdin Make sure to replace argocd for the namespace in which argo is being deployed Store the public key (so other people can encrypt secrets) 1 gpg --export --armor &quot;${GPG_ID}&quot; &gt; .sops.pub.asc And the key can be imported by other people with: 1 &gt; gpg --import .sops.pub.asc ` Configure ArgoCD with KSOPS On ArgoCD configmap (argocd-cm), add the following key and value: kustomize.buildOptions: –enable-alpha-plugins Patching ArgoCD Repo server Patch the Argo CD repo server deployment with the following contents: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 apiVersion: apps/v1 kind: Deployment metadata: name: argocd-repo-server namespace: argocd spec: template: spec: initContainers: - name: install-ksops image: viaductoss/ksops:v4.2.5 command: - /bin/sh - &#39;-c&#39; args: - &gt;- echo &quot;Installing KSOPS...&quot;; mv ksops /custom-tools/; mv kustomize/custom-tools/; echo &quot;Done.&quot;; volumeMounts: - mountPath: /custom-tools name: custom-tools - name: import-gpg-key image: argoproj/argocd:v2.1.7 command: [&quot;gpg&quot;, &quot;--import&quot;,&quot;/sops-gpg/sops.asc&quot;] env: - name: GNUPGHOME value: /gnupg-home/.gnupg volumeMounts: - mountPath: /sops-gpg name: sops-gpg - mountPath: /gnupg-home name: gnupg-home containers: - name: argocd-repo-server env: - name: XDG_CONFIG_HOME value: /.config - name: GNUPGHOME value: /home/argocd/.gnupg volumeMounts: - mountPath: /home/argocd/.gnupg name: gnupg-home subPath: .gnupg - mountPath: /usr/local/bin/kustomize name: custom-tools subPath: kustomize - mountPath: /.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops name: custom-tools subPath: ksops volumes: - name: custom-tools emptyDir: {} - name: gnupg-home emptyDir: {} - name: sops-gpg secret: secretName: sops-gpg What are we doing here? We are settign up an initContainer for our ArgoCD deployment, which contains: The KSOPS installer The GPG Key importer Patch it with: 1 $ kubectl patch deployment -n argocd argocd-repo-server --patch &quot;$(cat repo-deploy-patch.yaml) Creating a KSOPS secrets generator Inside the Kustmize overlay (info here), create a secret generator object: 1 2 3 4 5 6 7 apiVersion: viaduct.ai/v1 kind: ksops metadata: # Specify a name name: example-secret-generator files: - ./argo-secret.yaml Where argo-secret refers to the secret to be decrypted by ksops. With this done, reference the generator inside the kustomization.yaml file: 1 2 generators: - ./secrets-generator.yaml Conclusion And voilà! With this setup, everytime you need to encrypt a secret, you just need to: Encrypt the file with sops --encrypt &lt;filename&gt; (for example, a secrets.yaml file) Add the file reference to the secrets-generator.yaml file Commit the encrypted file to your Git Repo ArgoCD will take care of leveraging KSOPS for decrypting the secrets content" /><link rel="canonical" href="https://bressan.xyz/posts/secrets-sops-argo/" /><meta property="og:url" content="https://bressan.xyz/posts/secrets-sops-argo/" /><meta property="og:site_name" content="Rodrigo Bressan" /><meta property="og:image" content="https://bressan.xyz/assets/img/posts/10-secrets/banner.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-15T16:00:00+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://bressan.xyz/assets/img/posts/10-secrets/banner.jpeg" /><meta property="twitter:title" content="Managing K8S secrets with ArgoCD and SOPS" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-15T16:00:00+02:00","datePublished":"2023-05-15T16:00:00+02:00","description":"ArgoCD is a popular tool for managing Kubernetes resources, providing a declarative way to define and maintain the desired state of your applications running in a Kubernetes cluster. One essential aspect of deploying applications securely is managing secrets. Kubernetes provides the concept of secrets, but handling them effectively within ArgoCD can be a challenge. This is where Ksops comes to the rescue. In this blog post, we will explore how to use Ksops to manage secrets in ArgoCD, ensuring a more secure and efficient deployment process. Understanding ArgoCD Secrets Before diving into the details of Ksops, let’s briefly understand how ArgoCD manages secrets. ArgoCD uses a GitOps approach, storing application configurations in a Git repository. While application manifests can be version-controlled and audited, secrets require extra care due to their sensitive nature. ArgoCD offers several options for managing secrets: Git-Secrets: Secrets can be stored in a Git repository, encrypted using sops or a similar tool. However, this may not be the most secure option, as it still exposes secrets to anyone with access to the repository. External Secret Management: You can use an external secret management tool such as HashiCorp Vault, Kubernetes secrets, or a cloud provider’s secret manager. While this approach provides better security, it can be more complex to set up and manage. Enter Ksops Ksops (Kustomize-SOPS) is a powerful tool designed to simplify and secure the management of secrets in Kubernetes, especially in GitOps workflows like ArgoCD. Ksops takes a declarative approach to secret management, allowing you to store encrypted secrets alongside your application manifests in the same Git repository. It offers the following benefits: Zero Trust Secrets: With Ksops, secrets are stored in the same Git repository as your application manifests, but they are securely encrypted. This means you don’t have to rely on the secrecy of your Git repository, following the “Zero Trust” principle. Ease of Use: Ksops integrates seamlessly with ArgoCD and other GitOps tools, making it easy to incorporate into your existing workflow. Strong Encryption: Ksops uses strong encryption algorithms to protect your secrets, ensuring they remain confidential. Audit Trail: Since secrets are version-controlled in the Git repository, you can maintain a clear audit trail of who made changes to the secrets. Installing SOPS In order to install SOPS, make sure you have pip installed on your environment, and then download the SOPS package with: 1 $ pip install sops Configuring SOPS (Secrets Manager) Now that we have SOPS installed on our machine, let’s look on how to configure it to use our personal GPG keys Generate GPG Keys 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ export GPG_NAME=&quot;k3s.argotest.cluster&quot; $ export GPG_COMMENT=&quot;argocd secrets&quot; $ gpg --batch --full-generate-key &lt;&lt;EOF %no-protection Key-Type: 1 Key-Length: 4096 Subkey-Type: 1 Subkey-Length: 4096 Expire-Date: 0 Name-Comment: ${GPG_COMMENT} Name-Real: ${GPG_NAME} EOF With the following command, we create a new GPG key of 4096 bytes, and add a comment and name to it (in order to be able to distinguish it easily from others) Retrieve key name 1 $ gpg --list-secret-keys &quot;${GPG_NAME}&quot; This command will output you the ID of your GPG key, which will be used from now on to identiy your GPG key. Store the GPG key fingerprint as an environment variable 1 $ export GPG_ID=&lt;OUTPUT_FROM_PREVIOUS_COMMAND&gt; Export the public and private key pair from the GPG key and create a kubernetes secret for ArgoCD to read them 1 2 3 4 5 $ gpg --export-secret-keys --armor &quot;${GPG_ID}&quot; | kubectl create secret generic sops-gpg \\ --namespace=argocd \\ --from-file=sops.asc=/dev/stdin Make sure to replace argocd for the namespace in which argo is being deployed Store the public key (so other people can encrypt secrets) 1 gpg --export --armor &quot;${GPG_ID}&quot; &gt; .sops.pub.asc And the key can be imported by other people with: 1 &gt; gpg --import .sops.pub.asc ` Configure ArgoCD with KSOPS On ArgoCD configmap (argocd-cm), add the following key and value: kustomize.buildOptions: –enable-alpha-plugins Patching ArgoCD Repo server Patch the Argo CD repo server deployment with the following contents: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 apiVersion: apps/v1 kind: Deployment metadata: name: argocd-repo-server namespace: argocd spec: template: spec: initContainers: - name: install-ksops image: viaductoss/ksops:v4.2.5 command: - /bin/sh - &#39;-c&#39; args: - &gt;- echo &quot;Installing KSOPS...&quot;; mv ksops /custom-tools/; mv kustomize/custom-tools/; echo &quot;Done.&quot;; volumeMounts: - mountPath: /custom-tools name: custom-tools - name: import-gpg-key image: argoproj/argocd:v2.1.7 command: [&quot;gpg&quot;, &quot;--import&quot;,&quot;/sops-gpg/sops.asc&quot;] env: - name: GNUPGHOME value: /gnupg-home/.gnupg volumeMounts: - mountPath: /sops-gpg name: sops-gpg - mountPath: /gnupg-home name: gnupg-home containers: - name: argocd-repo-server env: - name: XDG_CONFIG_HOME value: /.config - name: GNUPGHOME value: /home/argocd/.gnupg volumeMounts: - mountPath: /home/argocd/.gnupg name: gnupg-home subPath: .gnupg - mountPath: /usr/local/bin/kustomize name: custom-tools subPath: kustomize - mountPath: /.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops name: custom-tools subPath: ksops volumes: - name: custom-tools emptyDir: {} - name: gnupg-home emptyDir: {} - name: sops-gpg secret: secretName: sops-gpg What are we doing here? We are settign up an initContainer for our ArgoCD deployment, which contains: The KSOPS installer The GPG Key importer Patch it with: 1 $ kubectl patch deployment -n argocd argocd-repo-server --patch &quot;$(cat repo-deploy-patch.yaml) Creating a KSOPS secrets generator Inside the Kustmize overlay (info here), create a secret generator object: 1 2 3 4 5 6 7 apiVersion: viaduct.ai/v1 kind: ksops metadata: # Specify a name name: example-secret-generator files: - ./argo-secret.yaml Where argo-secret refers to the secret to be decrypted by ksops. With this done, reference the generator inside the kustomization.yaml file: 1 2 generators: - ./secrets-generator.yaml Conclusion And voilà! With this setup, everytime you need to encrypt a secret, you just need to: Encrypt the file with sops --encrypt &lt;filename&gt; (for example, a secrets.yaml file) Add the file reference to the secrets-generator.yaml file Commit the encrypted file to your Git Repo ArgoCD will take care of leveraging KSOPS for decrypting the secrets content","headline":"Managing K8S secrets with ArgoCD and SOPS","image":"https://bressan.xyz/assets/img/posts/10-secrets/banner.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://bressan.xyz/posts/secrets-sops-argo/"},"url":"https://bressan.xyz/posts/secrets-sops-argo/"}</script><title>Managing K8S secrets with ArgoCD and SOPS | Rodrigo Bressan</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rodrigo Bressan"><meta name="application-name" content="Rodrigo Bressan"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/img/me.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><h1 class="site-title"> <a href="/">Rodrigo Bressan</a></h1><p class="site-subtitle fst-italic mb-0">Software, Healthcare and Improving People's lives</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-address-card"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-code"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-file"></i> <span>RESUME</span> </a><li class="nav-item"> <a href="/all-posts/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ALL POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/rodrigobressan" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/rbressan/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Managing K8S secrets with ArgoCD and SOPS</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4" ><article class="px-1"><header><h1 data-toc-skip>Managing K8S secrets with ArgoCD and SOPS</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1684159200" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 15, 2023 </time> </span><div class="mt-3 mb-3"> <a href="/assets/img/posts/10-secrets/banner.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/img/posts/10-secrets/banner.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/rodrigobressan">Rodrigo Bressan</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1001 words" > <em>5 min</em> read</span></div></div></header><div class="content"><p>ArgoCD is a popular tool for managing Kubernetes resources, providing a declarative way to define and maintain the desired state of your applications running in a Kubernetes cluster. One essential aspect of deploying applications securely is managing secrets. Kubernetes provides the concept of secrets, but handling them effectively within ArgoCD can be a challenge. This is where Ksops comes to the rescue. In this blog post, we will explore how to use Ksops to manage secrets in ArgoCD, ensuring a more secure and efficient deployment process.</p><h2 id="understanding-argocd-secrets"><span class="me-2">Understanding ArgoCD Secrets</span><a href="#understanding-argocd-secrets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Before diving into the details of Ksops, let’s briefly understand how ArgoCD manages secrets. ArgoCD uses a GitOps approach, storing application configurations in a Git repository. While application manifests can be version-controlled and audited, secrets require extra care due to their sensitive nature.</p><p>ArgoCD offers several options for managing secrets:</p><ol><li><p><strong>Git-Secrets</strong>: Secrets can be stored in a Git repository, encrypted using <code class="language-plaintext highlighter-rouge">sops</code> or a similar tool. However, this may not be the most secure option, as it still exposes secrets to anyone with access to the repository.</p><li><p><strong>External Secret Management</strong>: You can use an external secret management tool such as HashiCorp Vault, Kubernetes secrets, or a cloud provider’s secret manager. While this approach provides better security, it can be more complex to set up and manage.</p></ol><h2 id="enter-ksops"><span class="me-2">Enter Ksops</span><a href="#enter-ksops" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Ksops (Kustomize-SOPS) is a powerful tool designed to simplify and secure the management of secrets in Kubernetes, especially in GitOps workflows like ArgoCD. Ksops takes a declarative approach to secret management, allowing you to store encrypted secrets alongside your application manifests in the same Git repository. It offers the following benefits:</p><ol><li><p><strong>Zero Trust Secrets</strong>: With Ksops, secrets are stored in the same Git repository as your application manifests, but they are securely encrypted. This means you don’t have to rely on the secrecy of your Git repository, following the “Zero Trust” principle.</p><li><p><strong>Ease of Use</strong>: Ksops integrates seamlessly with ArgoCD and other GitOps tools, making it easy to incorporate into your existing workflow.</p><li><p><strong>Strong Encryption</strong>: Ksops uses strong encryption algorithms to protect your secrets, ensuring they remain confidential.</p><li><p><strong>Audit Trail</strong>: Since secrets are version-controlled in the Git repository, you can maintain a clear audit trail of who made changes to the secrets.</p></ol><h1 id="installing-sops">Installing SOPS</h1><p>In order to install SOPS, make sure you have <code class="language-plaintext highlighter-rouge">pip</code> installed on your environment, and then download the SOPS package with:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>pip <span class="nb">install </span>sops
</pre></table></code></div></div><h1 id="configuring-sops-secrets-manager">Configuring SOPS (Secrets Manager)</h1><p>Now that we have SOPS installed on our machine, let’s look on how to configure it to use our personal GPG keys</p><h2 id="generate-gpg-keys"><span class="me-2">Generate GPG Keys</span><a href="#generate-gpg-keys" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">export </span><span class="nv">GPG_NAME</span><span class="o">=</span><span class="s2">"k3s.argotest.cluster"</span>

<span class="nv">$ </span><span class="nb">export </span><span class="nv">GPG_COMMENT</span><span class="o">=</span><span class="s2">"argocd secrets"</span>

<span class="nv">$ </span>gpg <span class="nt">--batch</span> <span class="nt">--full-generate-key</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
%no-protection
Key-Type: 1
Key-Length: 4096
Subkey-Type: 1
Subkey-Length: 4096
Expire-Date: 0
Name-Comment: </span><span class="k">${</span><span class="nv">GPG_COMMENT</span><span class="k">}</span><span class="sh">
Name-Real: </span><span class="k">${</span><span class="nv">GPG_NAME</span><span class="k">}</span><span class="sh">
</span><span class="no">EOF
</span></pre></table></code></div></div><p>With the following command, we create a new GPG key of 4096 bytes, and add a comment and name to it (in order to be able to distinguish it easily from others)</p><h3 id="retrieve-key-name"><span class="me-2">Retrieve key name</span><a href="#retrieve-key-name" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>gpg <span class="nt">--list-secret-keys</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GPG_NAME</span><span class="k">}</span><span class="s2">"</span>
</pre></table></code></div></div><p>This command will output you the ID of your GPG key, which will be used from now on to identiy your GPG key.</p><h3 id="store-the-gpg-key-fingerprint-as-an-environment-variable"><span class="me-2">Store the GPG key fingerprint as an environment variable</span><a href="#store-the-gpg-key-fingerprint-as-an-environment-variable" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">export </span><span class="nv">GPG_ID</span><span class="o">=</span>&lt;OUTPUT_FROM_PREVIOUS_COMMAND&gt;
</pre></table></code></div></div><h3 id="export-the-public-and-private-key-pair-from-the-gpg-key-and-create-a-kubernetes-secret-for-argocd-to-read-them"><span class="me-2">Export the public and private key pair from the GPG key and create a kubernetes secret for ArgoCD to read them</span><a href="#export-the-public-and-private-key-pair-from-the-gpg-key-and-create-a-kubernetes-secret-for-argocd-to-read-them" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$ </span>gpg <span class="nt">--export-secret-keys</span> <span class="nt">--armor</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GPG_ID</span><span class="k">}</span><span class="s2">"</span> |
kubectl create secret generic sops-gpg <span class="se">\</span>
<span class="nt">--namespace</span><span class="o">=</span>argocd <span class="se">\</span>
<span class="nt">--from-file</span><span class="o">=</span>sops.asc<span class="o">=</span>/dev/stdin

</pre></table></code></div></div><p>Make sure to replace <code class="language-plaintext highlighter-rouge">argocd</code> for the namespace in which argo is being deployed</p><h3 id="store-the-public-key-so-other-people-can-encrypt-secrets"><span class="me-2">Store the public key (so other people can encrypt secrets)</span><a href="#store-the-public-key-so-other-people-can-encrypt-secrets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> gpg <span class="nt">--export</span> <span class="nt">--armor</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GPG_ID</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span> .sops.pub.asc
</pre></table></code></div></div><p>And the key can be imported by other people with:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> gpg <span class="nt">--import</span> .sops.pub.asc
</pre></table></code></div></div><p>`</p><h2 id="configure-argocd-with-ksops"><span class="me-2">Configure ArgoCD with KSOPS</span><a href="#configure-argocd-with-ksops" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>On ArgoCD configmap (<code class="language-plaintext highlighter-rouge">argocd-cm</code>), add the following key and value:</p><blockquote><p>kustomize.buildOptions: –enable-alpha-plugins</p></blockquote><h2 id="patching-argocd-repo-server"><span class="me-2">Patching ArgoCD Repo server</span><a href="#patching-argocd-repo-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Patch the Argo CD repo server deployment with the following contents:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">argocd-repo-server</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">argocd</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">initContainers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">install-ksops</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">viaductoss/ksops:v4.2.5</span>
          <span class="na">command</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">/bin/sh</span>
            <span class="pi">-</span> <span class="s1">'</span><span class="s">-c'</span>
          <span class="na">args</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="pi">&gt;-</span>
              <span class="s">echo "Installing KSOPS..."; </span>
              <span class="s">mv ksops /custom-tools/; </span>
              <span class="s">mv kustomize/custom-tools/; </span>
              <span class="s">echo "Done.";</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/custom-tools</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">custom-tools</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">import-gpg-key</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">argoproj/argocd:v2.1.7</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">gpg"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--import"</span><span class="pi">,</span><span class="s2">"</span><span class="s">/sops-gpg/sops.asc"</span><span class="pi">]</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">GNUPGHOME</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">/gnupg-home/.gnupg</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/sops-gpg</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">sops-gpg</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/gnupg-home</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">gnupg-home</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">argocd-repo-server</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">XDG_CONFIG_HOME</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">/.config</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">GNUPGHOME</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">/home/argocd/.gnupg</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/home/argocd/.gnupg</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">gnupg-home</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">.gnupg</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/usr/local/bin/kustomize</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">custom-tools</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">kustomize</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">custom-tools</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">ksops</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">custom-tools</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">gnupg-home</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sops-gpg</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">secretName</span><span class="pi">:</span> <span class="s">sops-gpg</span>
</pre></table></code></div></div><p>What are we doing here?</p><ul><li>We are settign up an <code class="language-plaintext highlighter-rouge">initContainer</code> for our ArgoCD deployment, which contains:<ul><li>The KSOPS installer<li>The GPG Key importer</ul></ul><p>Patch it with:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl patch deployment <span class="nt">-n</span> argocd argocd-repo-server <span class="nt">--patch</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">cat </span>repo-deploy-patch.yaml<span class="si">)</span><span class="s2">
</span></pre></table></code></div></div><h2 id="creating-a-ksops-secrets-generator"><span class="me-2">Creating a KSOPS secrets generator</span><a href="#creating-a-ksops-secrets-generator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Inside the Kustmize overlay (<a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/">info here</a>), create a secret generator object:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">viaduct.ai/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ksops</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="c1"># Specify a name</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">example-secret-generator</span>
<span class="na">files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">./argo-secret.yaml</span>
</pre></table></code></div></div><p>Where <code class="language-plaintext highlighter-rouge">argo-secret</code> refers to the secret to be decrypted by ksops.</p><p>With this done, reference the generator inside the <code class="language-plaintext highlighter-rouge">kustomization.yaml</code> file:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="na">generators</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">./secrets-generator.yaml</span>
</pre></table></code></div></div><h2 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>And voilà! With this setup, everytime you need to encrypt a secret, you just need to:</p><ul><li>Encrypt the file with <code class="language-plaintext highlighter-rouge">sops --encrypt &lt;filename&gt;</code> (for example, a <code class="language-plaintext highlighter-rouge">secrets.yaml</code> file)<li>Add the file reference to the <code class="language-plaintext highlighter-rouge">secrets-generator.yaml</code> file<li>Commit the <strong>encrypted</strong> file to your Git Repo<li>ArgoCD will take care of leveraging KSOPS for decrypting the secrets content</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/cloud/">cloud</a>, <a href="/categories/k8s/">k8s</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/cloud/" class="post-tag no-text-decoration" >cloud</a> <a href="/tags/k8s/" class="post-tag no-text-decoration" >k8s</a> <a href="/tags/argocd/" class="post-tag no-text-decoration" >argocd</a> <a href="/tags/sops/" class="post-tag no-text-decoration" >sops</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Managing%20K8S%20secrets%20with%20ArgoCD%20and%20SOPS%20-%20Rodrigo%20Bressan&url=https%3A%2F%2Fbressan.xyz%2Fposts%2Fsecrets-sops-argo%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Managing%20K8S%20secrets%20with%20ArgoCD%20and%20SOPS%20-%20Rodrigo%20Bressan&u=https%3A%2F%2Fbressan.xyz%2Fposts%2Fsecrets-sops-argo%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fbressan.xyz%2Fposts%2Fsecrets-sops-argo%2F&text=Managing%20K8S%20secrets%20with%20ArgoCD%20and%20SOPS%20-%20Rodrigo%20Bressan" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fbressan.xyz%2Fposts%2Fsecrets-sops-argo%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/lynis-audit/">Navigating HIPAA compliance on the Cloud with Lynis</a><li class="text-truncate lh-lg"> <a href="/posts/kopf-k8s-operator/">Simplifying Kubernetes Operators with Kopf: A Quick Guide</a><li class="text-truncate lh-lg"> <a href="/posts/k8s-commands/">Essential kubectl Commands</a><li class="text-truncate lh-lg"> <a href="/posts/nlp-basics/">NLP with Python: A Beginner's Guide</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/data-science/">data science</a> <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a> <a class="post-tag btn btn-outline-primary" href="/tags/cloud/">cloud</a> <a class="post-tag btn btn-outline-primary" href="/tags/feature-engineering/">feature engineering</a> <a class="post-tag btn btn-outline-primary" href="/tags/keras/">keras</a> <a class="post-tag btn btn-outline-primary" href="/tags/machine-learning/">machine learning</a> <a class="post-tag btn btn-outline-primary" href="/tags/pandas/">pandas</a> <a class="post-tag btn btn-outline-primary" href="/tags/scikit-learn/">scikit-learn</a> <a class="post-tag btn btn-outline-primary" href="/tags/tensorflow/">tensorflow</a> <a class="post-tag btn btn-outline-primary" href="/tags/devops/">devops</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4 mb-5"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/kopf-k8s-operator/" class="post-preview card h-100"><div class="card-body"> <time class="small" data-ts="1678888800" data-df="ll" > Mar 15, 2023 </time><h4 class="pt-0 my-2">Simplifying Kubernetes Operators with Kopf: A Quick Guide</h4><div class="text-muted small"><p> Kubernetes Operators are powerful tools for managing complex applications in Kubernetes, but they can be challenging to develop and maintain. Here you can find the white paper for the Operator patt...</p></div></div></a></article><article class="col"> <a href="/posts/k8s-commands/" class="post-preview card h-100"><div class="card-body"> <time class="small" data-ts="1681567200" data-df="ll" > Apr 15, 2023 </time><h4 class="pt-0 my-2">Essential kubectl Commands</h4><div class="text-muted small"><p> kubectl is the Swiss Army knife of Kubernetes, providing several commands to interact with your K8s cluster. In this blog post, we’ll explore a range of kubectl commands for various day-to-day oper...</p></div></div></a></article><article class="col"> <a href="/posts/lynis-audit/" class="post-preview card h-100"><div class="card-body"> <time class="small" data-ts="1676469600" data-df="ll" > Feb 15, 2023 </time><h4 class="pt-0 my-2">Navigating HIPAA compliance on the Cloud with Lynis</h4><div class="text-muted small"><p> Healthcare organizations face a unique challenge when it comes to securing patient data in the cloud. Ensuring HIPAA (Health Insurance Portability and Accountability Act) compliance is a top priori...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/hipaa-s3/" class="btn btn-outline-primary" aria-label="Older" ><p>HIPAA on AWS: S3 buckets</p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p> © <time>2025</time> <a href="https://github.com/rodrigobressan">Rodrigo Bressan</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>See something wrong? Want to contribute? <a href="https://github.com/rodrigobressan/rodrigobressan.github.io/tree/master/_posts">Edit this page 📝</href></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/data-science/">data science</a> <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a> <a class="post-tag btn btn-outline-primary" href="/tags/cloud/">cloud</a> <a class="post-tag btn btn-outline-primary" href="/tags/feature-engineering/">feature engineering</a> <a class="post-tag btn btn-outline-primary" href="/tags/keras/">keras</a> <a class="post-tag btn btn-outline-primary" href="/tags/machine-learning/">machine learning</a> <a class="post-tag btn btn-outline-primary" href="/tags/pandas/">pandas</a> <a class="post-tag btn btn-outline-primary" href="/tags/scikit-learn/">scikit-learn</a> <a class="post-tag btn btn-outline-primary" href="/tags/tensorflow/">tensorflow</a> <a class="post-tag btn btn-outline-primary" href="/tags/devops/">devops</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.9/dayjs.min.js,npm/dayjs@1.11.9/locale/en.min.js,npm/dayjs@1.11.9/plugin/relativeTime.min.js,npm/dayjs@1.11.9/plugin/localizedFormat.min.js,npm/tocbot@4.21.1/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-5B9QC89SHN"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-5B9QC89SHN'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
